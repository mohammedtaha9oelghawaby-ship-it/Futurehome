<!DOCTYPE html>
<html lang="en" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FUTURE HOME | RESTORED SOVEREIGN</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.4/ace.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;700;900&family=Noto+Sans+Arabic:wght@100;400;700;900&display=swap');
        
        :root {
            --gold: #c5a059;
            --obsidian: #050505;
            --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { font-family: 'Montserrat', sans-serif; background: #000; color: var(--gold); overflow: hidden; height: 100vh; margin: 0; }
        body.rtl { font-family: 'Noto Sans Arabic', sans-serif; direction: rtl; }

        /* --- UI CORE --- */
        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0; width: 380px;
            background: rgba(10,10,10,0.95); border-right: 1px solid rgba(197,160,89,0.1);
            z-index: 1000; padding: 60px 40px; transition: var(--transition);
        }
        body.rtl .sidebar { left: auto; right: 0; border-right: none; border-left: 1px solid rgba(197,160,89,0.1); }
        
        #main-viewport { margin-left: 380px; padding: 80px; height: 100vh; overflow-y: auto; }
        body.rtl #main-viewport { margin-left: 0; margin-right: 380px; }

        /* --- BUTTONS (RE-STABILIZED) --- */
        .btn-minimal {
            border: 1px solid rgba(197, 160, 89, 0.4); background: transparent; color: var(--gold);
            padding: 12px; font-size: 10px; text-transform: uppercase; letter-spacing: 3px;
            cursor: pointer; transition: 0.3s; font-weight: 700; width: 100%; display: block; text-align: center;
        }
        .btn-minimal:hover { background: var(--gold); color: #000; }

        /* --- SECURITY LAYERS --- */
        #security-shield {
            position: fixed; inset: 0; z-index: 9999; background: #000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        #cookie-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; background: #0a0a0a; border: 2px solid var(--gold);
            padding: 40px; z-index: 10000; display: none; text-align: center;
        }

        .asset-card {
            background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(197, 160, 89, 0.1);
            padding: 30px; cursor: pointer; transition: 0.3s;
        }
        .asset-card:hover { border-color: var(--gold); background: rgba(197, 160, 89, 0.05); }

        .modal {
            position: fixed; inset: 0; z-index: 11000; background: rgba(0,0,0,0.95);
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body id="bodyRoot">

    <div id="security-shield">
        <h1 class="text-gold tracking-[10px] font-black uppercase">SYSTEM LOCK</h1>
        <p id="security-status" class="text-[8px] tracking-[5px] uppercase mt-4 opacity-50">Checking Signatures...</p>
    </div>

    <div id="cookie-popup">
        <h4 class="text-gold font-black tracking-widest mb-4">SECURITY COOKIE REQUIRED</h4>
        <p class="text-[10px] opacity-70 mb-8">Initialize the local signature to access the Sovereign Node.</p>
        <button onclick="acceptSecurityCookies()" class="btn-minimal">INITIALIZE</button>
    </div>

    <div class="fixed top-8 right-8 z-[5000] flex gap-2">
        <button onclick="toggleLang('en')" class="btn-minimal !w-12">EN</button>
        <button onclick="toggleLang('ar')" class="btn-minimal !w-12">AR</button>
    </div>

    <aside class="sidebar">
        <h1 data-en="FUTURE HOME" data-ar="منزل المستقبل" class="text-center font-black tracking-[10px] mb-16">FUTURE HOME</h1>

        <div id="auth-section" class="space-y-4">
            <input type="email" id="email" class="w-full bg-white/5 border border-white/10 p-4 text-xs text-gold outline-none" placeholder="IDENTITY">
            <input type="password" id="password" class="w-full bg-white/5 border border-white/10 p-4 text-xs text-gold outline-none" placeholder="KEY">
            <button onclick="handleLogin()" class="btn-minimal">AUTHORIZE</button>
        </div>

        <div id="menu-master" class="hidden space-y-6 mt-10">
            <button onclick="openArchitect()" class="btn-minimal">ARCHITECT PANEL</button>
            <button onclick="openVault()" class="btn-minimal">VAULT RECORDS</button>
        </div>

        <div id="menu-agent" class="hidden space-y-4 mt-6">
            <button onclick="openAddListing()" class="btn-minimal">NEW LISTING</button>
        </div>

        <div id="menu-buyer" class="hidden space-y-4 mt-6">
            <button class="btn-minimal">FAVORITES</button>
        </div>

        <button onclick="handleLogout()" class="absolute bottom-8 left-8 text-[8px] tracking-widest text-red-700 font-bold">DISCONNECT</button>
    </aside>

    <main id="main-viewport" class="hidden">
        <h2 id="view-title" class="text-5xl font-thin tracking-tighter mb-12">EXPLORE</h2>
        <div id="listing-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </main>

    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 flex gap-4 z-[5000] bg-black/80 p-2 border border-white/10">
        <button onclick="switchPOV('buyer')" class="btn-minimal !px-4">BUYER POV</button>
        <button onclick="switchPOV('agent')" class="btn-minimal !px-4">AGENT POV</button>
        <button id="exit-pov" onclick="exitPOV()" class="btn-minimal !px-4 !border-red-900 hidden">EXIT POV</button>
    </div>

    <div id="modal-architect" class="modal">
        <div class="w-full h-full flex flex-col p-10">
            <div id="ace-editor" class="flex-1 border border-gold/20"></div>
            <div class="flex gap-4 mt-6">
                <button onclick="deployCode()" class="btn-minimal">DEPLOY</button>
                <button onclick="closeModals()" class="btn-minimal">CLOSE</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const fbConfig = {
            apiKey: "AIzaSyCkKmG3XSEDC2u_-HZYze8clabp6JLKf1g",
            authDomain: "futurehomeapp-fdad7.firebaseapp.com",
            projectId: "futurehomeapp-fdad7",
            storageBucket: "futurehomeapp-fdad7.appspot.com",
            messagingSenderId: "70607637960",
            appId: "1:70607637960:web:f11bbd6a3bc53cb4ab44fd"
        };

        const app = initializeApp(fbConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const masterEmail = "mohammedtaha9o.elghawaby@gmail.com";

        // RESTORED SECURITY ACTIONS
        window.acceptSecurityCookies = () => {
            document.cookie = "FH_ACCESS=MASTER_KEY; max-age=2592000; path=/";
            document.getElementById('cookie-popup').style.display = 'none';
            checkSecurity();
        };

        function checkSecurity() {
            const shield = document.getElementById('security-shield');
            if (document.cookie.includes("FH_ACCESS=MASTER_KEY")) {
                shield.style.display = 'none';
            } else {
                document.getElementById('cookie-popup').style.display = 'block';
            }
        }

        // RESTORED POV ACTIONS
        window.switchPOV = (role) => {
            document.getElementById('exit-pov').classList.remove('hidden');
            ['master', 'agent', 'buyer'].forEach(r => document.getElementById(`menu-${r}`)?.classList.add('hidden'));
            document.getElementById(`menu-${role}`).classList.remove('hidden');
        };
        window.exitPOV = () => location.reload();

        // RESTORED UI ACTIONS
        window.toggleLang = (lang) => {
            document.getElementById('bodyRoot').className = lang === 'ar' ? 'rtl' : '';
            document.querySelectorAll('[data-en]').forEach(el => el.innerText = el.getAttribute(`data-${lang}`));
        };

        window.handleLogin = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-viewport').classList.remove('hidden');
                const isM = user.email.toLowerCase() === masterEmail;
                document.getElementById(isM ? 'menu-master' : 'menu-agent').classList.remove('hidden');
            }
            checkSecurity();
        });

        // LISTINGS
        onSnapshot(query(collection(db, 'properties'), orderBy('createdAt', 'desc')), (snap) => {
            const grid = document.getElementById('listing-grid');
            grid.innerHTML = '';
            snap.forEach(d => {
                const p = d.data();
                grid.innerHTML += `<div class="asset-card" onclick="alert('Price: EGP ${p.price}')">
                    <p class="text-[7px] uppercase opacity-40">${p.location}</p>
                    <h4 class="text-xl uppercase">${p.title}</h4>
                </div>`;
            });
        });

        const editor = ace.edit("ace-editor");
        window.openArchitect = () => document.getElementById('modal-architect').style.display = 'flex';
        window.closeModals = () => document.getElementById('modal-architect').style.display = 'none';

    </script>
</body>
</html>
